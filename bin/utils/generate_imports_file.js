const fs = require("fs-extra");
const recursivly_find_dependencies = require("./recursivly_find_dependencies");
const path = require("path");

module.exports = (config) => {
    console.log(`Generating imports file`);
    let importsCode = `// This file is automatically generated by Leia's imports generator\n`;
    const tempAppPath = path.resolve(`${__dirname}/../../temp/app`);
    // Start modules 
    const modules = recursivly_find_dependencies(config);

    // Import code
    for (let i = 0; i < modules.length; i++) {
        const module = modules[i];
        const moduleConfig = fs.readJsonSync(`${tempAppPath}/src/modules/${module}/leia-config.json`);

        importsCode += `import {${moduleConfig.name}Module} from "./modules/${module}/${moduleConfig.entrypoint}";\n`;
    }

    importsCode += "\nexport const imports = [\n";
    for (let i = 0; i < modules.length; i++) {
        const module = modules[i];
        const moduleConfig = fs.readJsonSync(`${tempAppPath}/src/modules/${module}/leia-config.json`);
        importsCode += `\t${moduleConfig.name}Module${i !== modules.length - 1 ? "," : ""}\n`;
    }
    importsCode += "];";

    importsCode += "\n\nexport const modules = [\n";
    for (let i = 0; i < modules.length; i++) {
        const module = modules[i];
        const moduleConfig = fs.readJsonSync(`${tempAppPath}/src/modules/${module}/leia-config.json`);
        importsCode += `\t"${moduleConfig.name}"${i !== modules.length - 1 ? "," : ""}\n`;
    }
    importsCode += "];";
    fs.writeFileSync(`${tempAppPath}/src/module-imports.ts`, importsCode);
}